<div class="container-fluid">
  <div class="row" *ngIf="refreshInProgress">
    <mat-progress-bar class="mb-3" mode="determinate" value="{{currentProgress}}"></mat-progress-bar>
  </div>
  <div class="row">
    <div class="col-4">

        <mat-form-field class="w-100">
          <mat-label>Stock Name</mat-label>
          <input type="text" matInput [matAutocomplete]="auto" 
          (keyup)="getStockList($event)" [value]="currentStock.stock_name" style="font-size: 20px;">
          <mat-autocomplete #auto="matAutocomplete">
            <mat-option *ngFor="let stock of stockAutoCompleteList" [value]="stock.stock_name" 
            (click)="currentStock=stock; getAnalytics();">
              {{stock.stock_name}} <span class="badge badge-info">{{stock.stock_current_price}}</span>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      
    </div>
    <div class="col-8" *ngIf="currentStock.stock_id">

      <mat-form-field>
        <mat-label>History</mat-label>
        <mat-select value=30 (selectionChange)="changePriceHistory($event.value)">
            <mat-option value="30">30</mat-option>
            <mat-option value="60">60</mat-option>
            <mat-option value="180">180</mat-option>
            <mat-option value="365">1Y</mat-option>
            <mat-option value="720">2Y</mat-option>
            <mat-option value="1000">3Y</mat-option>
            <mat-option value="1800">5Y</mat-option>
            <!-- <mat-option value="365">365</mat-option> -->
        </mat-select>
      </mat-form-field>
      <button mat-icon-button color="accent" (click)="updateStockDetails(['price-history'])" [disabled]='refreshInProgress' title="Update DB">
        <mat-icon [class.fa-rotate]='refreshInProgress'>autorenew</mat-icon>
      </button>
      <mat-button-toggle-group [(value)]="equityMetric" (click)="changeMetric()" class="float-right">
        <mat-button-toggle value="latest" enabled="equityMetric='latest'">Latest</mat-button-toggle>
        <mat-button-toggle value="mean" enabled="equityMetric='mean'">Mean</mat-button-toggle>
        <!-- <mat-button-toggle value="underline">Underline</mat-button-toggle> -->
      </mat-button-toggle-group>

    </div>
  </div>
  <div class="row" *ngIf="currentStock.stock_id">
    <div class="col-6">
      <p>
        {{currentStock.stock_about}}
      </p>
      <mat-tab-group (selectedTabChange)="changePriceTab()" #phmode>
        <mat-tab label="Historic">
          <div id="price-history"></div>
        </mat-tab>
        <mat-tab label="Live">
          <div id="price-history-live"></div>
        </mat-tab>
      </mat-tab-group>
    </div>
    <div class="col-6">
      <div id="competition"></div>
    </div>
  </div>
  <div class="row">
    <div class="col-6">
      <div id="bank-quarter"></div>
      <div id="non-bank-quarter"></div>
    </div>
    <div class="col-6">
      <div id="price-bands"></div>
    </div>
  </div>
  <!-- <div class="row">
    <div class="col-12">
      
    </div>
  </div> -->
  <hr>
  <div class="row">
    <div class="col-12">

      <h2>Value Picks</h2>
      <div class="row">

        <div class="col-4">
          <mat-slider class="w-100" [(value)]="stockMaxPrice" min="0" max="3000" step="5" (change)="stockMaxPrice=$event.target.value;updateValuePicks()"></mat-slider>
        </div>
        <div class="col-4">
          <mat-form-field class="example-margin">
            <mat-label>Max Price</mat-label>
            <input type="text" matInput class="mx-auto"
              [value]="stockMaxPrice" (keyup)="stockMaxPrice=$event.target.value; updateValuePicks();" style="font-size: 20px;">
          </mat-form-field>
        </div>
        
      </div>
      <div class="row">
        <div class="col-6 card w-50" id="deals-distribution-buy" style="max-height: 400px;"></div>
        <!-- <div class="col-6 card w-50" id="deals-distribution-sell"></div> -->
        <div class="col-6 card w-50" id="br-distribution-buy" style="max-height: 400px;"></div>
        
      </div>
      <div class="row">
        <div class="col-8" id="top-mf-holdings"></div>
        <div class="col-4 card" style="height: 400px;">
          <div class="card-header">
            Top Value
            <span class="badge badge-primary">
              {{getLen(topValue | appFilter: eventKW : allStocks : 'stock_id')}}
            </span>
          </div>
          <div class="card-body p-0" style="overflow-y: auto;">
            <ul class="list-group m-0">
              <li class="list-group-item list-group-item-action m-0" 
              [class.active]="item.stock_id == currentStock.stock_id" 
              *ngFor="let item of topValue | appFilter: eventKW : allStocks : 'stock_id'" 
              (click)="setStock(getStockFromId(item.stock_id).stock_name)">
                
                <div class="float-left">
                  {{getStockFromId(item.stock_id).stock_name}}
                  <div class="badge badge-info p-1">
                    {{getStockFromId(item.stock_id).stock_current_price}}
                  </div>
                </div>
                <div class="float-right">
                    <div class="badge badge-secondary p-1">
                      P {{roundFloat(item.mean_profit)}}%
                    </div>
                    <div class="badge badge-secondary p-1">
                      D {{roundFloat(item.div_count)}}
                    </div>
                    <div class="badge badge-secondary p-1">
                      R {{item.br_count}}
                    </div>
                </div>
                  
                
              </li>
            </ul>
          </div>

        </div>
        <!-- <div class="col-6 card w-50" id="deals-distribution-sell"></div> -->
        <!-- <button (click)='getCommonStocks()'></button> -->
      </div>
    
    </div>
  </div>
  <hr>
  <div class="row">
    <div class="col-12">
      <div class="row">
        
        <h2 class="col-4">Events 
          <button mat-icon-button color="accent" (click)="updateAllStocks([])" [disabled]='refreshInProgress' title="Update DB">
            <mat-icon [class.fa-rotate]='refreshInProgress'>autorenew</mat-icon>
          </button>
          <button mat-icon-button color="accent" (click)="updateCommonData()" [disabled]='refreshInProgress' title="Update DB">
            <mat-icon [class.fa-rotate]='refreshInProgress'>play_for_work</mat-icon>
          </button>
        </h2>
      
      </div>
      <div class="row">

      
        <div class="col-6">
          <div class="row">
            <div class="col-4">
              <mat-form-field class="example-full-width w-100">
                <mat-label>Search</mat-label>
                <input matInput placeholder="Company" (keyup)="eventKW=$event.target.value; updatePagedFiltered();">
                
              </mat-form-field>
            </div>
            <div class="col-8">
              <div class="row">
                <div class="col-8">
                  <mat-slider class="w-100" [(value)]="stockMaxPrice" min="0" max="3000" step="5" (change)="updateValuePicks()"></mat-slider>
                </div>
                <div class="col-4">
                  <mat-form-field class="w-100">
                    <mat-label>Max Price</mat-label>
                    <input type="text" matInput class="mx-auto"
                      [value]="stockMaxPrice" (keyup)="stockMaxPrice=$event.target.value; updateValuePicks();" style="font-size: 20px;">
                  </mat-form-field>
                    
        
                </div>
              </div>
              
            </div>
          </div>
          
          <div class="row">
            <div class="col-12">
              <details class="card">
                <summary class="card-header">
      
                  Deals <span class="badge badge-primary">{{getLen(dealDetails | appFilter: eventKW : allStocks : 'deal_stock_id')}}</span>
                  <button mat-icon-button color="accent" (click)="updateAllStocks(['block-deals','bulk-deals'])" title="Update DB">
                    <mat-icon [class.fa-rotate]='refreshInProgress'>autorenew</mat-icon>
                  </button>
                  <span class="badge badge-info" title="{{getLatestCount(pagedFiltered['dealDetails'], 'deal_date').lValue}}">
                    {{getLatestCount(pagedFiltered['dealDetails'], 'deal_date').newCount}}
                  </span>
                </summary>
                
                <div class="card-body flex" style="max-height: 400px; overflow-y: auto;">
                  
                    <table mat-table [dataSource]="pagedFiltered['dealDetails']" class="mat-elevation-z8">
      
                      <ng-container matColumnDef="stockName">
                        <th mat-header-cell *matHeaderCellDef> Stock </th>
                        <td mat-cell *matCellDef="let element"> {{getStockFromId(element.deal_stock_id).stock_name}} </td>
                      </ng-container>
      
                      <ng-container matColumnDef="curPrice">
                        <th mat-header-cell *matHeaderCellDef> Cur Price </th>
                        <td mat-cell *matCellDef="let element" [class.bg-success]="getStockFromId(element.deal_stock_id).stock_current_price<element.deal_price">  
                          {{getStockFromId(element.deal_stock_id).stock_current_price}}
                        </td>
                      </ng-container>
                    
                      <ng-container matColumnDef="dealType">
                        <th mat-header-cell *matHeaderCellDef> Type </th>
                        <td mat-cell *matCellDef="let element"> {{element.deal_type}} </td>
                      </ng-container>
      
                      <ng-container matColumnDef="dealTransType">
                        <th mat-header-cell *matHeaderCellDef> Trans </th>
                        <td mat-cell *matCellDef="let element" class="bg-success" [class.bg-danger]="element.deal_trans_type=='Sell'"> {{element.deal_trans_type}} </td>
                      </ng-container>
                    
                      <ng-container matColumnDef="dealTitle">
                        <th mat-header-cell *matHeaderCellDef> Title </th>
                        <td mat-cell *matCellDef="let element"> {{element.deal_title}} </td>
                      </ng-container>
      
                      <ng-container matColumnDef="dealQty">
                        <th mat-header-cell *matHeaderCellDef> Qty </th>
                        <td mat-cell *matCellDef="let element"> {{element.deal_qty}} </td>
                      </ng-container>
      
                      <ng-container matColumnDef="dealPrice">
                        <th mat-header-cell *matHeaderCellDef> Price </th>
                        <td mat-cell *matCellDef="let element"> {{element.deal_price}} </td>
                      </ng-container>
      
                      <ng-container matColumnDef="dealDate">
                        <th mat-header-cell *matHeaderCellDef> Date </th>
                        <td mat-cell *matCellDef="let element"> {{element.deal_date}} </td>
                      </ng-container>
                    
                      <tr mat-header-row *matHeaderRowDef="displayedColumns['deals']"></tr>
                      <tr mat-row *matRowDef="let row; columns: displayedColumns['deals'];"></tr>
      
                    </table>
                    <mat-paginator [length]="getLen(filterDataWithPipe(dealDetails, eventKW, 'deal_stock_id'))" [pageSize]="30" (page)="onChangePage($event, filterDataWithPipe(dealDetails, eventKW, 'deal_stock_id'), 'dealDetails')"></mat-paginator>
                
                </div>
      
              </details>
      
              <details class="card">
                <summary class="card-header">
                  Insider <span class="badge badge-primary">{{getLen(insDetails | appFilter: eventKW : allStocks : 'ins_stock_id')}}</span>
                  <button mat-icon-button color="accent" (click)="updateAllStocks(['insider-transaction'])" title="Update DB">
                    <mat-icon [class.fa-rotate]='refreshInProgress'>autorenew</mat-icon>
                  </button>
                  <span class="badge badge-info" title="{{getLatestCount(pagedFiltered['insDetails'], 'ins_date').lValue}}">
                    {{getLatestCount(pagedFiltered['insDetails'], 'ins_date').newCount}}
                  </span>
                </summary>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                  <table mat-table [dataSource]="pagedFiltered['insDetails']" class="mat-elevation-z8">
      
                    <ng-container matColumnDef="stockName">
                      <th mat-header-cell *matHeaderCellDef> Stock </th>
                      <td mat-cell *matCellDef="let element">
                        {{getStockFromId(element.ins_stock_id).stock_name}}
                      </td>
                    </ng-container>
                  
                    <ng-container matColumnDef="name">
                      <th mat-header-cell *matHeaderCellDef> Insider </th>
                      <td mat-cell *matCellDef="let element"> {{element.ins_name}} </td>
                    </ng-container>
      
                    <ng-container matColumnDef="category">
                      <th mat-header-cell *matHeaderCellDef> Category </th>
                      <td mat-cell *matCellDef="let element"> {{element.ins_category}} </td>
                    </ng-container>
                  
      
                    <ng-container matColumnDef="transactionDate">
                      <th mat-header-cell *matHeaderCellDef> Transaction Date </th>
                      <td mat-cell *matCellDef="let element"> {{element.ins_date}} </td>
                    </ng-container>
      
                    <ng-container matColumnDef="qty">
                      <th mat-header-cell *matHeaderCellDef> Qty </th>
                      <td mat-cell *matCellDef="let element"> {{element.ins_qty}} </td>
                    </ng-container>
      
                    <ng-container matColumnDef="curPrice">
                      <th mat-header-cell *matHeaderCellDef> Cur Price </th>
                      <td mat-cell *matCellDef="let element" [class.bg-success]="getStockFromId(element.ins_stock_id).stock_current_price < element.ins_price">  
                        {{getStockFromId(element.ins_stock_id).stock_current_price}}
                      </td>
                    </ng-container>
      
                    <ng-container matColumnDef="price">
                      <th mat-header-cell *matHeaderCellDef> Price </th>
                      <td mat-cell *matCellDef="let element"> {{element.ins_price}} </td>
                    </ng-container>
      
                    <ng-container matColumnDef="action">
                      <th mat-header-cell *matHeaderCellDef> Action </th>
                      <td mat-cell *matCellDef="let element" class="bg-success" [class.bg-danger]="element.ins_action=='Disposal'"> {{element.ins_action}} </td>
                    </ng-container>
      
                    <ng-container matColumnDef="mode">
                      <th mat-header-cell *matHeaderCellDef> Mode </th>
                      <td mat-cell *matCellDef="let element"> {{element.ins_mode}} </td>
                    </ng-container>
      
                    <ng-container matColumnDef="holding">
                      <th mat-header-cell *matHeaderCellDef> Post Holding </th>
                      <td mat-cell *matCellDef="let element"> {{element.ins_post_per_hold}} </td>
                    </ng-container>
                  
                    <tr mat-header-row *matHeaderRowDef="displayedColumns['insider']"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns['insider'];"></tr>
      
                  </table>
                  <!-- <mat-paginator [length]="getLen(insDetails)" [pageSize]="30" (page)="onChangePage($event, insDetails, 'insDetails')"></mat-paginator> -->
                  <mat-paginator [length]="getLen(filterDataWithPipe(insDetails, eventKW, 'ins_stock_id'))" [pageSize]="30" (page)="onChangePage($event, filterDataWithPipe(insDetails, eventKW, 'ins_stock_id'), 'insDetails')"></mat-paginator>
                </div>
              </details>
      
              <details class="card">
                <summary class="card-header">
                  Broker Research <span class="badge badge-primary">{{getLen(brDetails | appFilter: eventKW : allStocks : 'brokres_stock_id')}}</span>
                  <button mat-icon-button color="accent" (click)="updateAllStocks(['broker-research','broker-research-2'])" title="Update DB">
                    <mat-icon [class.fa-rotate]='refreshInProgress'>autorenew</mat-icon>
                  </button>

                  <span class="badge badge-info" title="{{getLatestCount(pagedFiltered['brDetails'], 'brokres_rec_date').lValue}}">
                    {{getLatestCount(pagedFiltered['brDetails'], 'brokres_rec_date').newCount}}
                  </span>
                </summary>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                  <table mat-table [dataSource]="pagedFiltered['brDetails']" class="mat-elevation-z8">
      
                    <ng-container matColumnDef="stockName">
                      <th mat-header-cell *matHeaderCellDef> Stock </th>
                      <td mat-cell *matCellDef="let element" (click)="setStock(getStockFromId(element.brokres_stock_id).stock_name)"> 
                        {{getStockFromId(element.brokres_stock_id).stock_name}} 
                      </td>
                    </ng-container>
                  
                    <ng-container matColumnDef="organization">
                      <th mat-header-cell *matHeaderCellDef> Org </th>
                      <td mat-cell *matCellDef="let element"> 
                        {{element.brokres_org}}
                        <span class="badge badge-warning" 
                          matTooltip="{{brokerRatings[element.brokres_org].hits}} / {{brokerRatings[element.brokres_org].total_recoms}} | L {{brokerRatings[element.brokres_org].min_date_diffs}} - M {{brokerRatings[element.brokres_org].mean_date_diffs}} - U {{brokerRatings[element.brokres_org].max_date_diffs}}">
                          {{roundFloat(brokerRatings[element.brokres_org]['hits']*100/brokerRatings[element.brokres_org]['total_recoms'])}}%
                        </span> 
                      </td>
                    </ng-container>
      
                    <ng-container matColumnDef="flag">
                      <th mat-header-cell *matHeaderCellDef> Flag </th>
                      <td mat-cell *matCellDef="let element"> <a href="{{element.brokres_attachment}}">{{element.brokres_rec_flag}}</a> </td>
                    </ng-container>
                  
      
                    <ng-container matColumnDef="recDate">
                      <th mat-header-cell *matHeaderCellDef> Rec Date </th>
                      <td mat-cell *matCellDef="let element"> {{element.brokres_rec_date}} </td>
                    </ng-container>
                    
                    <ng-container matColumnDef="curPrice">
                      <th mat-header-cell *matHeaderCellDef> Cur Price </th>
                      <td mat-cell *matCellDef="let element">  
                        {{getStockFromId(element.brokres_stock_id).stock_current_price}}
                      </td>
                    </ng-container>
      
                    <ng-container matColumnDef="recPrice">
                      <th mat-header-cell *matHeaderCellDef> Rec Price </th>
                      <td mat-cell *matCellDef="let element" [class.bg-success]="getStockFromId(element.brokres_stock_id).stock_current_price < element.brokres_rec_price"> {{element.brokres_rec_price}} </td>
                    </ng-container>
      
                    <ng-container matColumnDef="targetPrice">
                      <th mat-header-cell *matHeaderCellDef> Target </th>
                      <td mat-cell *matCellDef="let element" [class.bg-success]="getStockFromId(element.brokres_stock_id).stock_current_price < getFloatFromLocale(element.brokres_target)">
                        {{element.brokres_target}}
                      </td>
                    </ng-container>  
      
                    <ng-container matColumnDef="margin">
                      <th mat-header-cell *matHeaderCellDef> Margin </th>
                      <td mat-cell *matCellDef="let element" [class.bg-warning]="(getFloatFromLocale(element.brokres_target) - getStockFromId(element.brokres_stock_id).stock_current_price)*100/getStockFromId(element.brokres_stock_id).stock_current_price > 50">
                        {{roundFloat((getFloatFromLocale(element.brokres_target) - getStockFromId(element.brokres_stock_id).stock_current_price)*100/getStockFromId(element.brokres_stock_id).stock_current_price)}}%
                      </td>
                    </ng-container>  
                    <ng-container matColumnDef="valid_flag">
                      <th mat-header-cell *matHeaderCellDef> Validity </th>
                      <td mat-cell *matCellDef="let element">
                        <button class="btn btn-info mx-auto" [class.btn-danger]="!element.brokres_rec_valid_flag" (click)="toggleBrokerRes(element.brokres_id)">
                          Flip
                        </button>
                      </td>
                    </ng-container>
                    <ng-container matColumnDef="check_flag">
                      <th mat-header-cell *matHeaderCellDef> Check </th>
                      <td mat-cell *matCellDef="let element">
                        <button class="btn btn-info mx-auto" (click)="checkBrokerRes(element.brokres_id)">
                          Check
                        </button>
                      </td>
                    </ng-container> 
                  
                    <tr mat-header-row *matHeaderRowDef="displayedColumns['br']"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns['br'];"></tr>
      
                  </table>
                  <!-- <mat-paginator [length]="getLen(brDetails)" [pageSize]="30" (page)="onChangePage($event, brDetails, 'brDetails')"></mat-paginator> -->
                  <mat-paginator [length]="getLen(filterDataWithPipe(brDetails, eventKW, 'brokres_stock_id'))" [pageSize]="30" (page)="onChangePage($event, filterDataWithPipe(brDetails, eventKW, 'brokres_stock_id'), 'brDetails')"></mat-paginator>
                
                </div>
              </details>
      
              <details class="card">
                <summary class="card-header">
                  Dividends <span class="badge badge-primary">{{getLen(divDetails | appFilter: eventKW : allStocks : 'div_stock_id')}}</span>
                </summary>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                  <table mat-table [dataSource]="pagedFiltered['divDetails']" class="mat-elevation-z8">
      
                    <ng-container matColumnDef="stockName">
                      <th mat-header-cell *matHeaderCellDef> Stock </th>
                      <td mat-cell *matCellDef="let element"> {{getStockFromId(element.div_stock_id).stock_name}} </td>
                    </ng-container>
      
                    <ng-container matColumnDef="curPrice">
                      <th mat-header-cell *matHeaderCellDef> Cur Price </th>
                      <td mat-cell *matCellDef="let element">  
                        {{getStockFromId(element.div_stock_id).stock_current_price}}
                      </td>
                    </ng-container>
                  
                    <ng-container matColumnDef="divType">
                      <th mat-header-cell *matHeaderCellDef> Type </th>
                      <td mat-cell *matCellDef="let element"> {{element.div_type}} </td>
                    </ng-container>
                  
      
                    <ng-container matColumnDef="divEffectiveDate">
                      <th mat-header-cell *matHeaderCellDef> Effective Date </th>
                      <td mat-cell *matCellDef="let element"> {{element.div_eff_date}} </td>
                    </ng-container>
                  
      
                    <ng-container matColumnDef="divAnnoDate">
                      <th mat-header-cell *matHeaderCellDef> Annoucement Date </th>
                      <td mat-cell *matCellDef="let element"> {{element.div_anno_date}} </td>
                    </ng-container>
      
                    <ng-container matColumnDef="divRemarks">
                      <th mat-header-cell *matHeaderCellDef> Remarks </th>
                      <td mat-cell *matCellDef="let element"> {{element.div_remarks}} </td>
                    </ng-container>
                  
                    <tr mat-header-row *matHeaderRowDef="displayedColumns['dividends']"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns['dividends'];"></tr>
      
                  </table>
                  <!-- <mat-paginator [length]="getLen(divDetails)" [pageSize]="30" (page)="onChangePage($event, divDetails, 'divDetails')"></mat-paginator> -->
                  <mat-paginator [length]="getLen(filterDataWithPipe(divDetails, eventKW, 'div_stock_id'))" [pageSize]="30" (page)="onChangePage($event, filterDataWithPipe(divDetails, eventKW, 'div_stock_id'), 'divDetails')"></mat-paginator>
                
                </div>
              </details>
      
              <details class="card">
                <summary class="card-header">
                  AGM <span class="badge badge-primary">{{getLen(agmDetails | appFilter: eventKW : allStocks : 'agm_stock_id')}}</span>
                </summary>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                  <table mat-table [dataSource]="pagedFiltered['agmDetails']" class="mat-elevation-z8">
      
                    <ng-container matColumnDef="stockName">
                      <th mat-header-cell *matHeaderCellDef> Stock </th>
                      <td mat-cell *matCellDef="let element"> {{getStockFromId(element.agm_stock_id).stock_name}} </td>
                    </ng-container>
      
                    <ng-container matColumnDef="curPrice">
                      <th mat-header-cell *matHeaderCellDef> Cur Price </th>
                      <td mat-cell *matCellDef="let element">  
                        {{getStockFromId(element.agm_stock_id).stock_current_price}}
                      </td>
                    </ng-container>
                  
                    <ng-container matColumnDef="agmPurpose">
                      <th mat-header-cell *matHeaderCellDef> Purpose </th>
                      <td mat-cell *matCellDef="let element"> {{element.agm_purpose}} </td>
                    </ng-container>
                  
                    <ng-container matColumnDef="agmDate">
                      <th mat-header-cell *matHeaderCellDef> AGM Date </th>
                      <td mat-cell *matCellDef="let element"> {{element.agm_date}} </td>
                    </ng-container>
                  
                    <ng-container matColumnDef="agmAnnoDate">
                      <th mat-header-cell *matHeaderCellDef> Annoucement Date </th>
                      <td mat-cell *matCellDef="let element"> {{element.agm_annoc_date}} </td>
                    </ng-container>
      
                    <ng-container matColumnDef="agmRemarks">
                      <th mat-header-cell *matHeaderCellDef> Remarks </th>
                      <td mat-cell *matCellDef="let element"> {{element.agm_remarks}} </td>
                    </ng-container>
                  
                    <tr mat-header-row *matHeaderRowDef="displayedColumns['agm']"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns['agm'];"></tr>
      
                  </table>
                  <!-- <mat-paginator [length]="getLen(agmDetails)" [pageSize]="30" (page)="onChangePage($event, agmDetails, 'agmDetails')"></mat-paginator> -->
                  <mat-paginator [length]="getLen(filterDataWithPipe(agmDetails, eventKW, 'agm_stock_id'))" [pageSize]="30" (page)="onChangePage($event, filterDataWithPipe(agmDetails, eventKW, 'agm_stock_id'), 'agmDetails')"></mat-paginator>
                
                </div>
              </details>
      
              <details class="card">
                <summary class="card-header">
                  News <span class="badge badge-primary">{{getLen(newsDetails | appFilter: eventKW : allStocks : 'news_stock_id')}}</span>
                  <button mat-icon-button color="accent" (click)="updateAllStocks(['news'])" title="Update DB">
                    <mat-icon [class.fa-rotate]='refreshInProgress'>autorenew</mat-icon>
                  </button>
                  <span class="badge badge-info" title="{{getLatestCount(pagedFiltered['newsDetails'], 'news_creation_date').lValue}}">
                    {{getLatestCount(pagedFiltered['newsDetails'], 'news_creation_date').newCount}}
                  </span>
                </summary>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                  <table mat-table [dataSource]="pagedFiltered['newsDetails']" class="mat-elevation-z8">
      
                    <ng-container matColumnDef="stockName">
                      <th mat-header-cell *matHeaderCellDef> Stock </th>
                      <td mat-cell *matCellDef="let element"> {{getStockFromId(element.news_stock_id).stock_name}} </td>
                    </ng-container>
                  
                    <ng-container matColumnDef="curPrice">
                      <th mat-header-cell *matHeaderCellDef> Cur Price </th>
                      <td mat-cell *matCellDef="let element">  
                        {{getStockFromId(element.news_stock_id).stock_current_price}}
                      </td>
                    </ng-container>
                    
                  
                    <ng-container matColumnDef="newsDate">
                      <th mat-header-cell *matHeaderCellDef> Date </th>
                      <td mat-cell *matCellDef="let element"> {{element.news_creation_date}} </td>
                    </ng-container>
      
                    <ng-container matColumnDef="newsHead">
                      <th mat-header-cell *matHeaderCellDef> Head </th>
                      <td mat-cell *matCellDef="let element">
                        <a href="{{element.news_post_url}}">
                          {{element.news_heading}}
                        </a>
                      </td>
                    </ng-container>
                  
                    
                  
                    <tr mat-header-row *matHeaderRowDef="displayedColumns['news']"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns['news'];"></tr>
      
                  </table>
                  <!-- <mat-paginator [length]="getLen(newsDetails)" [pageSize]="30" (page)="onChangePage($event, newsDetails, 'newsDetails')"></mat-paginator> -->
                  <mat-paginator [length]="getLen(filterDataWithPipe(newsDetails, eventKW, 'news_stock_id'))" [pageSize]="30" (page)="onChangePage($event, filterDataWithPipe(newsDetails, eventKW, 'news_stock_id'), 'newsDetails')"></mat-paginator>
                
                </div>
              </details>
      
              <details class="card">
                <summary class="card-header">
                  BM <span class="badge badge-primary">{{getLen(bmDetails | appFilter: eventKW : allStocks : 'bm_stock_id')}}</span>
                </summary>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
      
                  <table mat-table [dataSource]="pagedFiltered['bmDetails']" class="mat-elevation-z8">
      
                    <ng-container matColumnDef="stockName">
                      <th mat-header-cell *matHeaderCellDef> Stock </th>
                      <td mat-cell *matCellDef="let element"> {{getStockFromId(element.bm_stock_id).stock_name}} </td>
                    </ng-container>
      
                    <ng-container matColumnDef="curPrice">
                      <th mat-header-cell *matHeaderCellDef> Cur Price </th>
                      <td mat-cell *matCellDef="let element">  
                        {{getStockFromId(element.bm_stock_id).stock_current_price}}
                      </td>
                    </ng-container>
                  
                    <ng-container matColumnDef="bmRemarks">
                      <th mat-header-cell *matHeaderCellDef> Remarks </th>
                      <td mat-cell *matCellDef="let element"> {{element.bm_remarks}} </td>
                    </ng-container>
                  
                    <ng-container matColumnDef="bmDate">
                      <th mat-header-cell *matHeaderCellDef> Date </th>
                      <td mat-cell *matCellDef="let element"> {{element.bm_date}} </td>
                    </ng-container>
      
                  
                    <tr mat-header-row *matHeaderRowDef="displayedColumns['bm']"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns['bm'];"></tr>
      
                  </table>
                  <!-- <mat-paginator [length]="getLen(bmDetails)" [pageSize]="30" (page)="onChangePage($event, bmDetails, 'bmDetails')"></mat-paginator> -->
                  <mat-paginator [length]="getLen(filterDataWithPipe(bmDetails, eventKW, 'bm_stock_id'))" [pageSize]="30" (page)="onChangePage($event, filterDataWithPipe(bmDetails, eventKW, 'bm_stock_id'), 'bmDetails')"></mat-paginator>
                
                </div>
              </details>
            </div>
          </div>
            
          
        </div>
        <div class="col-6">
          <div class="row">
            <mat-slider class="col-10" [(value)]="changeLB" min="1" max="720" step="1" (change)="getTopChangers()"></mat-slider>
            <mat-form-field class="col-2">
              <mat-label>ChangeLB</mat-label>
              <input type="text" matInput
                [value]="changeLB" (keyup)="changeLB=$event.target.value;getTopChangers();" style="font-size: 20px;">
            </mat-form-field>
          </div>
          <div class="row">
            <div class="col-6 card" style="height: 400px;">
              <div class="card-header">
                Top Gainers
                <span class="badge badge-primary">
                  {{getLen(topGainers | appFilter: eventKW : allStocks : 'stock_id')}}
                </span>
              </div>
              <div class="card-body p-0" style="overflow-y: auto;">
                <ul class="list-group m-0">
                  <li class="list-group-item list-group-item-action m-0" [class.active]="item.stock_id == currentStock.stock_id" *ngFor="let item of topGainers | appFilter: eventKW : allStocks : 'stock_id'" (click)="setStock(getStockFromId(item.stock_id).stock_name)">
                    {{getStockFromId(item.stock_id).stock_name}}
                    <div class="float-right">
                      <div class="badge badge-info p-1">
                        {{item.stock_current_price}}
                      </div>
                      <div class="badge badge-success p-1" title="{{item.stock_then_date}}">
                        {{roundFloat(item.profit_loss)}}%
                        <!-- <mat-icon class="m-0">arrow_drop_up</mat-icon> -->
                      </div>
                    </div>
                    
                  </li>
                  
                </ul>
              </div>
              
              
            </div>
            <div class="col-6 card" style="height: 400px;">
              <div class="card-header">
                Top Losers
                <span class="badge badge-primary">
                  {{getLen(topLosers | appFilter: eventKW : allStocks : 'stock_id')}}
                </span>
              </div>
              <div class="card-body p-0" style="overflow-y: auto;">
                <ul class="list-group m-0">
                  <li class="list-group-item list-group-item-action m-0" [class.active]="item.stock_id == currentStock.stock_id" *ngFor="let item of topLosers | appFilter: eventKW : allStocks : 'stock_id'" (click)="setStock(getStockFromId(item.stock_id).stock_name)">
                    {{getStockFromId(item.stock_id).stock_name}}
                    <div class="float-right">
                      <div class="badge badge-info p-1">
                        {{item.stock_current_price}}
                      </div>
                      <div class="badge badge-danger p-1" title="{{item.stock_then_date}}">
                        {{roundFloat(item.profit_loss)}}%
                        <!-- <mat-icon>arrow_drop_down</mat-icon> -->
                      </div>
                    </div>
                    
                  </li>
                </ul>
              </div>

            </div>

          </div>
          
          
          
        
        
        </div>
      </div>
    </div>
        
      
  </div>
  <div class="row">
      <div class="col-3">
        <mat-form-field class="example-full-width">
          <mat-label>Sector</mat-label>
          <input matInput placeholder="Computer" (keyup)="sectorKW=$event.target.value">
        </mat-form-field>
        <section style="max-height: 400px; overflow-y: auto;">
          <!-- <mat-list>
            <mat-list-item *ngFor="let sector of allSectors">
              <mat-checkbox class="m-1">
                {{sector}}
              </mat-checkbox>
            </mat-list-item>
          </mat-list> -->
          <mat-selection-list #selectedOptions>
            <mat-list-option *ngFor="let sector of (allSectors | appFilter: sectorKW)" [value]="sector" (click)="updateSectorSelection($event)"
              [selected]="checkInSelection(sector)"
            >
              {{sector}}
            </mat-list-option>
          </mat-selection-list>
          
        </section>
        <div class="btn btn-group">
          <button mat-stroked-button class="btn btn-warning" (click)="getStocksBySector()">
            <mat-icon>refresh</mat-icon>
          </button>
          <button mat-stroked-button class="btn btn-warning" (click)="resetSectorSelection()">
            <mat-icon>reset_tv</mat-icon>
          </button>
          <button mat-stroked-button class="btn btn-warning" (click)="allSectorSelection()">
            <mat-icon>done_all</mat-icon>
          </button>
          
        </div>
        <mat-button-toggle-group [(value)]="equityMetric" (click)="getStocksBySector()" class="float-right">
          <mat-button-toggle value="latest" enabled="equityMetric='latest'">Latest</mat-button-toggle>
          <mat-button-toggle value="mean" enabled="equityMetric='mean'">Mean</mat-button-toggle>
          <!-- <mat-button-toggle value="underline">Underline</mat-button-toggle> -->
        </mat-button-toggle-group>
        <br>
        
        
      </div>
    
      
      <div class="col-9">
        <div id="sectors" style="min-height: 500px;"></div>
        <hr>
        <div class="btn-block">
          <button mat-button class="btn btn-sm border" (click)="removeSector(sector)" *ngFor="let sector of selectedSectors">
            {{sector}}
            <mat-icon class="mx-auto">close</mat-icon>
          </button>
        </div>
      </div>
    </div>
      



  <hr>

</div>
    